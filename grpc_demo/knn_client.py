#!/usr/bin/env python
# -*- coding: utf-8 -*-

# proto file: tensorflow_serving/apis/knn_service.proto
# python -m grpc_tools.protoc -I../../apis --python_out=. --grpc_python_out=. ../../apis/knn_service.proto ../../apis/model.proto
# python knn_lookup_client.py 127.0.0.1:8500

# from __future__ import print_function

import sys, grpc, numpy
import tensorflow as tf

import knn_service_pb2
import knn_service_pb2_grpc

svr_port = sys.argv[1]

def main(_):
    with grpc.insecure_channel(svr_port) as channel:
        try:
            stub = knn_service_pb2_grpc.KNNServiceStub(channel)
            req = knn_service_pb2.KNNSearchRequest()
            req.top_k = 10
            req.query_embedding.extend([-0.0144221, 0.0882536, -0.13076, 0.0903113, -0.171587, -0.0382318, -0.00380973, 0.109776, 0.241763, -0.129058, -0.0444547, 0.0672859, -0.0730785, 0.100786, -0.133318, 0.072313, 0.0675468, 0.14162, 0.0228558, 0.235427, -0.0287732, 0.0629476, 0.15785, 0.31693, -0.0363023, -0.121222, -0.192569, 0.0595559, -0.0356031, -0.00329891, -0.0193293, 0.016998, 0.142205, 0.0663469, -0.178226, -0.200581, 0.173822, 0.0446098, -0.0247473, 0.0777582, 0.0486323, -0.133048, -0.153659, -0.0269162, -0.164505, -0.166899, 0.193208, -0.165954, -0.165567, -0.0470185, -0.0857027, -0.0827909, -0.0988698, -0.180152, -0.00821304, -0.0417577, -0.0528333, 0.162118, 0.281205, -0.0291878, -0.113648, 0.0755228, 0.129958, -0.0481773])
            # error test
            # req.query_embedding.extend([0.0882536, -0.13076, 0.0903113, -0.171587, -0.0382318, -0.00380973, 0.109776, 0.241763, -0.129058, -0.0444547, 0.0672859, -0.0730785, 0.100786, -0.133318, 0.072313, 0.0675468, 0.14162, 0.0228558, 0.235427, -0.0287732, 0.0629476, 0.15785, 0.31693, -0.0363023, -0.121222, -0.192569, 0.0595559, -0.0356031, -0.00329891, -0.0193293, 0.016998, 0.142205, 0.0663469, -0.178226, -0.200581, 0.173822, 0.0446098, -0.0247473, 0.0777582, 0.0486323, -0.133048, -0.153659, -0.0269162, -0.164505, -0.166899, 0.193208, -0.165954, -0.165567, -0.0470185, -0.0857027, -0.0827909, -0.0988698, -0.180152, -0.00821304, -0.0417577, -0.0528333, 0.162118, 0.281205, -0.0291878, -0.113648, 0.0755228, 0.129958, -0.0481773])
            req.model_spec.name = 'knn'
            res = stub.KNNSearch(req)
            for item in res.pair_list:
                # print(item.sku_id, item.score)
                print '%-15d%15f' % (item.sku_id, item.score)
        except Exception as ex:
            print 'Error: %s' % ex

if __name__ == '__main__':
    tf.app.run()
